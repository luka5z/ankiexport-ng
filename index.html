<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polyglot</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#268bd2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --sol-base3: #fdf6e3; --sol-base2: #eee8d5; --sol-base1: #93a1a1;
            --sol-base00: #657b83; --sol-base01: #586e75; --sol-blue: #268bd2;
            --sol-violet: #6c71c4; --sol-magenta: #d33682; --sol-green: #859900;
            --sol-yellow: #b58900; --sol-red: #dc322f; --sol-cyan: #2aa198;
            --sol-orange: #cb4b16;
            --bg: var(--sol-base3); --surface: var(--sol-base2);
            --text-main: var(--sol-base00); --text-muted: var(--sol-base01);
            --primary: var(--sol-blue); --border: var(--sol-base1);
            --radius: 8px;
        }
        [data-theme="dark"] {
            --bg: #002b36; --surface: #073642; --text-main: #839496; --text-muted: #93a1a1; --input-bg: #002b36;
        }
        * { box-sizing: border-box; }
        body { font-family: "Public Sans", sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 1rem; display: flex; justify-content: center; min-height: 100vh; }
        .container { background: var(--surface); width: 100%; max-width: 600px; padding: 1.5rem; border-radius: var(--radius); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .header-row { display: flex; justify-content: space-between; margin-bottom: 1.5rem; align-items: center; }
        h1 { margin: 0; color: var(--primary); }
        .theme-toggle { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-muted); }
        .search-box { display: flex; gap: 10px; margin-bottom: 1rem; }
        input { flex: 1; padding: 14px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 16px; }
        button.action-btn { padding: 12px; border: none; border-radius: var(--radius); background: var(--primary); color: #fff; cursor: pointer; font-weight: 600; }
        
        #result-container { margin-top: 1rem; }
        /* Anki Card Styles */
        #anki-front { background: rgba(38,139,210,0.1); border-left: 4px solid var(--sol-blue); padding: 15px; border-radius: 4px; margin-bottom: 15px; font-family: "Souvenir Std", Georgia, serif; }
        #translate-div { background: rgba(108,113,196,0.1); border-left: 4px solid var(--sol-violet); padding: 15px; border-radius: 4px; margin-bottom: 15px; display: none; font-family: "Souvenir Std", Georgia, serif; }
        #definitions-content { background: rgba(133,153,0,0.1); border-left: 4px solid var(--sol-green); padding: 15px; border-radius: 4px; font-family: "Souvenir Std", Georgia, serif; }
        
        .word-title { font-size: 1.8rem; font-weight: bold; }
        .phonetic { font-family: monospace; color: var(--text-muted); font-size: 1.1rem; }
        .pl-label { color: var(--sol-violet); font-weight: bold; font-size: 0.8rem; margin-right: 5px; }
        .diki-label { color: var(--sol-cyan); font-weight: bold; font-size: 0.8rem; margin-right: 5px; }
        .phonetic-label { color: var(--sol-orange); font-weight: bold; font-size: 0.8rem; margin-right: 5px; }
        .part-of-speech { font-style: italic; font-weight: bold; background: var(--text-muted); color: var(--surface); padding: 2px 6px; border-radius: 4px; font-size: 0.85rem; }
        .pos-inline { font-style: italic; color: var(--sol-base01); font-size: 0.9rem; }
        
        .pl-phonetic-text b { color: var(--sol-magenta); font-weight: 900; }
        .pl-phonetic-text { font-family: monospace; }
        
        ul { margin: 5px 0 0 1.2rem; }
        li { margin-bottom: 8px; }
        .view-hidden { display: none; }
        .loader { text-align: center; margin-top: 2rem; color: var(--text-muted); display: none; }
        .action-bar { display: none; gap: 10px; margin-bottom: 1rem; }
        .btn-export { flex: 1; background: var(--text-muted); }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-view" class="container">
        <div class="header-row">
            <h1>Login</h1>
            <button class="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
        </div>
        <input type="password" id="token-input" placeholder="API Token..." onkeydown="if(event.key==='Enter') login()">
        <button onclick="login()" class="action-btn" style="width:100%; margin-top:10px;">Unlock</button>
    </div>

    <!-- APP -->
    <div id="app-view" class="container view-hidden">
        <div class="header-row">
            <h1>Polyglot</h1>
            <button class="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
        </div>
        
        <div class="search-box">
            <input type="text" id="word-input" placeholder="Word..." onkeydown="if(event.key==='Enter') searchWord()">
            <button onclick="searchWord()" class="action-btn"><i class="fas fa-search"></i></button>
        </div>

        <div class="action-bar" id="action-bar">
            <button class="action-btn btn-export" onclick="exportToAnki()">Download CSV</button>
        </div>

        <div id="loader" class="loader"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
        <div id="result-container"></div>
        
        <div style="margin-top:20px; text-align:right;">
             <button onclick="logout()" style="background:none; border:none; color:var(--sol-red); cursor:pointer;">Logout</button>
        </div>
    </div>

<script>
    const API_BASE = "https://iuy3bnzf16.execute-api.us-east-1.amazonaws.com"; // Terraform Output
    const TOKEN_KEY = "polyglot_api_token";

    function initAuth() {
        if(localStorage.getItem(TOKEN_KEY)) {
            document.getElementById('login-view').classList.add('view-hidden');
            document.getElementById('app-view').classList.remove('view-hidden');
        }
    }
    function login() {
        const t = document.getElementById('token-input').value.trim();
        if(t) { localStorage.setItem(TOKEN_KEY, t); initAuth(); }
    }
    function logout() {
        localStorage.removeItem(TOKEN_KEY);
        location.reload();
    }
    function toggleTheme() {
        const h = document.documentElement;
        h.setAttribute('data-theme', h.getAttribute('data-theme')==='light'?'dark':'light');
    }

    async function searchWord() {
        const word = document.getElementById('word-input').value.trim();
        if(!word) return;

        // Reset UI
        document.getElementById('result-container').innerHTML = '';
        document.getElementById('action-bar').style.display = 'none';
        document.getElementById('loader').style.display = 'block';

        // Render Initial Skeleton
        renderEntry({ word: word });

        // 1. Call Dictionary (Definitions)
        const pDict = fetch(`${API_BASE}/dictionary`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'x-api-token': localStorage.getItem(TOKEN_KEY)},
            body: JSON.stringify({ word: word })
        }).then(r => r.json());

        // 2. Call Translate (Google + Rich Data)
        const pTrans = fetch(`${API_BASE}/translate`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'x-api-token': localStorage.getItem(TOKEN_KEY)},
            body: JSON.stringify({ word: word })
        }).then(r => r.json());

        try {
            const [dictData, transData] = await Promise.all([pDict, pTrans]);
            
            // Merge & Render
            // Front Card: Word + IPA
            // Use IPA from Translate service if available (it has IPA from Diki/Cambridge)
            const finalIpa = transData.ipa || (dictData.phonetics?.[0]?.text) || '';
            document.querySelector('.phonetic').innerText = finalIpa;
            
            // Back Card: Translation + Polish Phonetic + Web Defs
            const transDiv = document.getElementById('translate-div');
            let transHtml = '';
            
            // 1. Google Translation
            if (transData.translation) {
                transHtml += `<div><span class="pl-label">TRANSLATE</span> ${transData.translation}</div>`;
            }
            
            // 2. Polish Phonetic Approximation (from Phonetic Lambda)
            if (transData.phonetic_pl) {
                // Bold Capitalized letters for stress emphasis
                const fmt = transData.phonetic_pl.replace(/([A-ZĄĆĘŁŃÓŚŹŻ]+)/g, '<b>$1</b>');
                transHtml += `<div style="margin-top:4px;"><span class="phonetic-label">PHONETIC</span> <span class="pl-phonetic-text">[${fmt}]</span></div>`;
            }
            
            // 3. Web Definitions (Diki/Cambridge)
            if (transData.meanings && transData.meanings.length > 0) {
                const parts = transData.meanings.map(g => {
                    const defs = g.definitions.join(', ');
                    if(g.part_of_speech && g.part_of_speech !== 'unknown') {
                        return `<span class="pos-inline">${g.part_of_speech}</span>: ${defs}`;
                    }
                    return defs;
                });
                transHtml += `<div style="margin-top:8px;"><span class="diki-label">WEB</span> ${parts.join('; ')}</div>`;
            }
            
            if (transHtml) {
                transDiv.innerHTML = transHtml;
                transDiv.style.display = 'block';
            }

            // Render English Definitions
            const defsContent = document.getElementById('definitions-content');
            if (dictData.meanings) {
                let html = '';
                dictData.meanings.slice(0, 3).forEach(m => {
                    html += `<div style="margin-bottom:10px;"><span class="part-of-speech">${m.partOfSpeech}</span><ul>`;
                    m.definitions.slice(0, 3).forEach(d => {
                        html += `<li>${d.definition}</li>`;
                    });
                    html += `</ul></div>`;
                });
                defsContent.innerHTML = html;
            } else if (dictData.error) {
                defsContent.innerHTML = `<em>${dictData.error}</em>`;
            }

            document.getElementById('action-bar').style.display = 'flex';

        } catch (e) {
            alert("Error: " + e.message);
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }

    function renderEntry(entry) {
        document.getElementById('result-container').innerHTML = `
            <div id="anki-front">
                <div style="display:flex; justify-content:space-between;">
                    <span class="word-title">${entry.word}</span>
                    <span class="phonetic"></span>
                </div>
            </div>
            <div id="anki-back">
                <div id="translate-div"></div>
                <div id="definitions-content"></div>
            </div>
        `;
    }

    function exportToAnki() {
        const front = document.getElementById('anki-front').innerHTML.replace(/\n/g, '').trim();
        const back = document.getElementById('anki-back').innerHTML.replace(/\n/g, '').trim();
        const csv = `"${front.replace(/"/g, '""')}","${back.replace(/"/g, '""')}"`;
        
        const blob = new Blob([csv], {type: 'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'card.csv';
        a.click();
    }

    initAuth();
</script>
</body>
</html>


